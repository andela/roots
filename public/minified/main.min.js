"use strict";angular.module("eventApp",["ui.router","ngMaterial","ngMessages","ngResource","ngAnimate","ngAria","summernote","ngFileUpload","ngAutocomplete","color.picker","ui.bootstrap","ui.bootstrap.datetimepicker","ngMap"]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("landing.home",{url:"/home",templateUrl:"../app/views/home.view.html",controller:"homeCtrl"}).state("landing",{url:"/landing",templateUrl:"../app/views/navbar.view.html",controller:"homeCtrl"}).state("user.passwordreset",{url:"/passwordreset/:token",templateUrl:"../app/views/password.reset.html",controller:"resetPasswordCtrl"}).state("user.registration",{url:"/registration",templateUrl:"../app/views/twitter.user.html",controller:"twitterCtrl"}).state("user.cevent",{url:"/cevent",templateUrl:"../app/views/event.view.html",controller:"eventCtrl"}).state("user",{url:"/user",templateUrl:"../app/views/user.view.html",controller:"homeCtrl"}).state("user.editEvent",{url:"/event/:event_id",templateUrl:"../app/views/editEvent.view.html",controller:"editeventCtrl"}).state("user.profile",{url:"/profile",templateUrl:"../app/views/user.profile.html",controller:"profileCtrl"}).state("user.eventDetails",{url:"/eventdetails/:event_id",templateUrl:"../app/views/eventDetails.view.html",controller:"eventViewCtrl"}).state("user.moreEvents",{url:"/more-events",templateUrl:"../app/views/more.events.view.html",controller:"moreEventsCtrl"}),t.otherwise("/landing/home")}]),angular.module("eventApp").directive("countryList",function(){return{restrict:"E",scope:{countryCode:"="},templateUrl:"../app/views/country.list.html"}}),angular.module("eventApp").config(["$mdThemingProvider",function(e){var t=e.extendPalette("red",{500:"000000"});e.definePalette("neonRed",t),e.theme("default").primaryPalette("neonRed").accentPalette("light-blue",{"default":"50"}).warnPalette("red")}]),angular.module("eventApp").directive("addressBasedGoogleMap",function(){return{restrict:"A",template:"<div id='addressMap'></div>",scope:{address:"=",zoom:"="},controller:["$scope",function(e){var t,o,n,r,a=function(){t=new google.maps.Geocoder;var r={zoom:e.zoom,center:o,mapTypeId:google.maps.MapTypeId.ROADMAP};n=new google.maps.Map(document.getElementById("addressMap"),r)},i=function(){t.geocode({address:e.address},function(e,t){t===google.maps.GeocoderStatus.OK&&(n.setCenter(e[0].geometry.location),r=new google.maps.Marker({map:n,position:e[0].geometry.location}))})};e.$watch("address",function(){void 0!==e.address&&i()}),a()}]}}),angular.module("eventApp").directive("jqdatepicker",function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModelCtrl){$(element).datepicker({dateFormat:"mm-dd-yy",minDate:0,onSelect:function(date){var ngModelName=this.attributes["ng-model"].value;if(-1!==ngModelName.indexOf(".")){var objAttributes=ngModelName.split("."),lastAttribute=objAttributes.pop(),partialObjString=objAttributes.join("."),partialObj=eval("scope."+partialObjString);partialObj[lastAttribute]=date}else scope[ngModelName]=date;scope.$apply()}})}}}),angular.module("eventApp").controller("editeventCtrl",["$scope","$stateParams","$location","EventService","OrganizerService","Upload","$rootScope","$state","$sce",function(e,t,o,n,r,a,i,s,l){function u(e){return new Date(Date.parse(e))}localStorage.getItem("userToken")||o.url("/user/home"),i.hideBtn=!0,n.getEvent(t.event_id).success(function(t){t.startDate=u(t.startDate),t.endDate=u(t.endDate),e.event=t,$(".md-warn").css("border-color",t.eventTheme.borderColor),$(".md-warn").css("background-color",t.eventTheme.headerColor),$(".md-warn").css("color",t.eventTheme.fontColor),$(".values").css("border-color",t.eventTheme.borderColor),$(".values").css("background-color",t.eventTheme.contentColor),$(".values").css("color",t.eventTheme.fontColor),t.user_ref.organizer_ref&&r.getOrganizer(t.user_ref.organizer_ref).success(function(o){e.organizer=o,e.organizer.phoneNumber1=t.user_ref.phoneNumber1})}),e.categories="Technology,Sport,Health & Fitness,Music,Food & Drink,Arts,Parties,Business".split(",").map(function(e){return{name:e}}),e.previewImg=function(e,t,o){$(e).on("change",function(){var n=document.querySelector(t),r=document.querySelector(e).files[0],a=document.querySelector(o),i=new FileReader;i.onloadend=function(){n.src=i.result,a&&(a.src=i.result)},r?i.readAsDataURL(r):(n.src="",a.src="")})},e.submitEventDetails=function(o){return o.startDate&&o.endDate?o.startDate>o.endDate?void $window.alert("invalid date range"):(o.venue.country=e.getCountryCode().text,void n.editEventDetails(o,t.event_id).success(function(e){s.go("user.eventDetails",{event_id:t.event_id}),document.body.scrollTop=document.documentElement.scrollTop=0})):void $window.alert("Select event start and end dates")},e.getCountryCode=function(){var e=document.getElementById("ddlViewBy"),t=e.options[e.selectedIndex].value,o=e.options[e.selectedIndex].text;return{code:t,text:o}},e.getCountry=function(){e.result="",e.options1={country:e.getCountryCode().code},e.details=""},e.cancelEdit=function(){s.go("user.eventDetails",{event_id:t.event_id}),document.body.scrollTop=document.documentElement.scrollTop=0},e.switchView=function(){e.prev=!e.prev,document.body.scrollTop=document.documentElement.scrollTop=0},e.$watch("event.description",function(t,o){t!==o&&(e.eventInfo=l.trustAsHtml(e.event.description))}),e.prev=!1}]),angular.module("eventApp").controller("eventCtrl",["$scope","$stateParams","UserService","$location","EventService","Upload","$rootScope","$state","$window","$sce",function(e,t,o,n,r,a,i,s,l,u){localStorage.getItem("userToken")?(i.hideBtn=!0,o.getCurrentUser().success(function(t){t.organizer_ref&&(e.organizer=t.organizer_ref,e.organizer.phoneNumber1=t.phoneNumber1,e.organizer.phoneNumber2=t.phoneNumber2)}).error(function(e){})):n.url("/home"),i.hideBtn=!0,e.submitEventDetails=function(t,o){return t.startDate&&t.endDate?t.startDate>t.endDate?void l.alert("invalid date range"):(t.venue.country=e.getCountryCode().text,e.isLoading=!0,r.createEvent(t).success(function(e){s.go("user.eventDetails",{event_id:e._id}),document.body.scrollTop=document.documentElement.scrollTop=0}),void 0):void l.alert("Select event start and end dates")},e.view="create",e.currDisplay=function(t){e.view=t},e.switchView=function(){e.prev=!e.prev,document.body.scrollTop=document.documentElement.scrollTop=0},e.categories="Technology,Sport,Health,Music,Art,Science,Spirituality,Media,Family,Education,Party".split(",").map(function(e){return{name:e}}),e.getCountryCode=function(){var e=document.getElementById("ddlViewBy"),t=e.options[e.selectedIndex].value,o=e.options[e.selectedIndex].text;return{code:t,text:o}},e.getCountry=function(){e.venue||(e.venue={}),e.venue.address="",e.options1={country:e.getCountryCode().code},e.details=""},e.publishEvent=function(t){e.event.online=t},e.previewImg=function(e,t,o){$(e).on("change",function(){var n=document.querySelector(t),r=document.querySelector(e).files[0],a=document.querySelector(o),i=new FileReader;i.onloadend=function(){n.src=i.result,a&&(a.src=i.result)},r&&a||r?i.readAsDataURL(r):(n.src="",a.src="")})},e.changeColor=function(e){$("md-toolbar.md-warn").css("background-color",e)},e.$watch("event.description",function(t,o){t!==o&&(e.eventInfo=u.trustAsHtml(e.event.description))}),e.event={eventTheme:{headerColor:"rgb(30, 25, 84)",borderColor:"",fontColor:"rgb(155, 86, 86)",contentColor:""},venue:{}},e.fetchEvents=function(){r.getAllEvents().then(function(t){e.eventList=t.data})},e.prev=!1,e.organizer={about:"",phoneNumber1:""}}]),angular.module("eventApp").controller("eventViewCtrl",["$scope","$stateParams","$location","EventService","OrganizerService","$rootScope","$state","$sce",function(e,t,o,n,r,a,i,s){e.services=function(){n.getEvent(t.event_id).success(function(t){e.event=t,e.event.description=s.trustAsHtml(e.event.description),$(".md-warn").css("background-color",t.eventTheme.headerColor),$(".md-warn").css("color",t.eventTheme.fontColor),$(".values").css("border-color",t.eventTheme.borderColor),$(".values").css("background-color",t.eventTheme.contentColor),$(".values").css("color",t.eventTheme.fontColor),e.canPublish=a.loggedIn&&a.userId===e.event.user_ref._id&&!e.event.online,e.canEdit=a.loggedIn&&a.userId===e.event.user_ref._id,t.user_ref.organizer_ref&&r.getOrganizer(t.user_ref.organizer_ref).success(function(o){e.organizer=o,e.organizer.phoneNumber1=t.user_ref.phoneNumber1})})},a.hideBtn=!1,e.editEvent=function(){i.go("user.editEvent",{event_id:t.event_id}),document.body.scrollTop=document.documentElement.scrollTop=0},e.deleteEvent=function(){n.deleteEvent(t.event_id),o.url("/home")},e.publishEvent=function(){n.publishEvent(t.event_id).success(function(t){e.canPublish=!1})}}]),angular.module("eventApp").controller("homeCtrl",["$scope","$rootScope","$mdDialog","$mdToast","UserService","$location","$state","EventService",function(e,t,o,n,r,a,i,s){function l(e,t,o,n){function a(e){var t=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;return t.test(e)}"signup"===n?e.signupDialog=!0:e.loginDialog=!0,e.closeDialog=function(){o.hide()},e.toggleDialog=function(){e.signupDialog=!e.signupDialog,e.loginDialog=!e.loginDialog},e.toggleView=function(){e.loginDialog=!e.loginDialog,e.resetDialog=!e.resetDialog},e.loginUser=function(n){e.wrongEmail=!1,e.wrongPassword=!1,r.authenticate(n).then(function(n){e.progressLoad=!0,"Authentication failed. User not found."===n.data.message?(e.wrongEmail=!0,e.wrongPassword=!1,e.progressLoad=!1):"Authentication failed. Wrong password."===n.data.message?(e.wrongEmail=!1,e.wrongPassword=!0,e.progressLoad=!1):(localStorage.setItem("userToken",n.data.token),t.signupCheck(),o.hide())})},e.signupUser=function(t){a(t.email)?(e.progressLoad=!0,r.createUser(t).then(function(o){o.data.message?(e.emailTaken=!0,e.progressLoad=!1,e.validEmail=!1):e.loginUser({email:t.email,password:t.password})})):(e.emailTaken=!1,e.validEmail=!0)},e.resetLink=function(t){r.sendLink(t).then(function(o){e.errorEmail=!1,e.progressBar=!0,"No user found"===o.data.message&&t?(e.errorEmail=!0,e.progressBar=!1):"Message Sent!"===o.data.message&&(e.emailSent=!0),e.progressBar=!1})}}$("a[href='#downpage']").click(function(){return $("html, body").animate({scrollTop:$("#event-list").offset().top},"slow"),!1}),t.hideBtn=!1;var u=a.search().token;a.search("token",null),u&&localStorage.setItem("userToken",u),t.signupCheck=function(){localStorage.getItem("userToken")&&r.decodeUser()},e.logout=function(){localStorage.removeItem("userToken"),t.loggedIn=!1,a.url("/home")},e.login=function(e){o.show({clickOutsideToClose:!0,controller:l,locals:{view:e},templateUrl:"app/views/login.view.html"})},e.toEvent=function(){e.loggedIn===!0&&a.path("/cevent")},e.fetchEvents=function(){s.getAllEvents().then(function(t){e.eventList=t.data})},l.$inject=["$scope","$rootScope","$mdDialog","view"],t.sendWelcomeMail=function(e){var t={mail:e.email,name:e.firstname};r.sendWelcomeMail(t).success(function(e,t,o,n){})},e.openEventDetails=function(e){i.go("user.eventDetails",{event_id:e}),document.body.scrollTop=document.documentElement.scrollTop=0}}]),angular.module("eventApp").controller("moreEventsCtrl",["$scope","$rootScope","EventService",function(e,t,o){e.fetchEvents=function(){o.getAllEvents().then(function(t){e.eventList=t.data})},e.categories="Technology,Sport,Health,Music,Art,Science,Spirituality,Media,Family,Education,Party".split(",").map(function(e){return{name:e}}),e.getCountryCode=function(){var e=document.getElementById("ddlViewBy"),t=e.options[e.selectedIndex].value,o=e.options[e.selectedIndex].text;return{code:t,text:o}},e.find={name:"",category:"",venue:{country:""}},e.countryCode="",e.$watch("countryCode",function(){return e.countryCode?void(e.find.venue.country=e.getCountryCode().text):void(e.find.venue.country="")}),t.hideBtn=!1}]),angular.module("eventApp").controller("profileCtrl",["$scope","$rootScope","EventService","OrganizerService","Upload","UserService","$state","$window",function(e,t,o,n,r,a,i,s){function l(e){if(!e)return"";var t=new Date(Date.parse(e)),o=Number(t.getMonth())+1+"-"+t.getDate()+"-"+t.getFullYear();return o}function u(e,t){422===Number(t)||401===Number(t)||403===Number(t)?s.alert(e.message):s.alert("An error just occured, please try again!")}localStorage.getItem("userToken")?(t.hideBtn=!1,e.userEditMode=!1,e.organizerEditMode=!0,e.orgProfileExists=!1,e.tempUserProfile,e.tempOrgProfile,e.organizer={},a.getCurrentUser().success(function(t){t.organizer_ref&&(e.organizer=t.organizer_ref,e.organizerEditMode=!1,e.orgProfileExists=!0),e.userInformation=t,t.profilePic||(e.userInformation.profilePic="../../assets/img/icons/default-avatar.png"),e.syncGenderDateDet()}).error(function(e,t){u(e,t)}),o.getMyPublishedEvents().success(function(t){e.publishedEvents=t}).error(function(e,t){u(e,t)}),o.getMyEventDrafts().success(function(t){e.eventDrafts=t}).error(function(e,t){u(e,t)})):$location.url("/home"),e.organizerButtnSave=function(){return e.organizer.name?void(e.orgProfileExists?e.editOrganizer():e.registerOrganizer()):void s.alert("Name field is mandatory!")},e.registerOrganizer=function(){n.createProfile(e.organizer).success(function(t){e.userInformation.organizer_ref=t._id,e.organizer=t,e.organizerEditMode=!1,e.orgProfileExists=!0}).error(function(e,t){u(e,t)})},e.editOrganizer=function(){n.editProfile(e.organizer).success(function(t){e.organizer=t,e.organizerEditMode=!1}).error(function(e,t){u(e,t)})},e.deleteOrganizer=function(){n.deleteProfile().success(function(t){e.organizerEditMode=!0,e.orgProfileExists=!1,e.userInformation.organizer_ref=void 0,e.organizer={},e.organizer.newImage=void 0}).error(function(e,t){u(e,t)})},e.updateUser=function(){return e.userInformation.firstname&&e.userInformation.lastname&&e.userInformation.email?void a.editProfile(e.userInformation).success(function(t){localStorage.setItem("userToken",t.token),a.decodeUser(),e.userInformation=t.user,e.syncGenderDateDet(),e.userEditMode=!1}).error(function(e,t){u(e,t)}):void s.alert("Fill all mandatory fields!")},e.uploadPicture=function(){return e.userInformation.newImage?void a.uploadPicture({newImage:e.userInformation.newImage}).success(function(t){localStorage.setItem("userToken",t.token),a.decodeUser(),e.userInformation.profilePic=t.user.profilePic,e.userEditMode=!1}).error(function(e,t){u(e,t)}):void s.alert("Choose a photo to upload!")},e.previewImg=function(e,t){$(e).on("change",function(){var o=document.querySelector(t),n=document.querySelector(e).files[0],r=new FileReader;r.onloadend=function(){o.src=r.result},n?r.readAsDataURL(n):o.src=""})},e.switchUserEditMode=function(t){e.userEditMode=t,e.userInformation.newImage=void 0,t?e.tempUserProfile=angular.copy(e.userInformation):e.userInformation=angular.copy(e.tempUserProfile)},e.switchOrganizerEditMode=function(t){e.organizerEditMode=t,e.organizer.newImage=void 0,t?e.tempOrgProfile=angular.copy(e.organizer):e.organizer=angular.copy(e.tempOrgProfile)},e.syncGenderDateDet=function(){"m"===angular.lowercase(e.userInformation.gender)?e.userInformation.genderDet="Male":"f"===angular.lowercase(e.userInformation.gender)?e.userInformation.genderDet="Female":e.userInformation.genderDet=e.userInformation.gender,e.userInformation.dobDet=l(e.userInformation.dateOfBirth)},e.editEvent=function(e){i.go("user.editEvent",{event_id:e}),document.body.scrollTop=document.documentElement.scrollTop=0},e.viewEvent=function(e){i.go("user.eventDetails",{event_id:e}),document.body.scrollTop=document.documentElement.scrollTop=0},e.deleteEvent=function(e,t){o.deleteEvent(e).success(function(){for(var o=0;o<t.length;o++)if(t[o]._id===e){t.splice(o,1);break}})}}]),angular.module("eventApp").controller("resetPasswordCtrl",["$scope","UserService","$stateParams","$location","$timeout",function(e,t,o,n,r){e.token=o.token,e.savePassword=function(o,a){e.password1===e.password2?t.resetPassword(o,{password:a}).success(function(t){e.successMessage=!0,e.passwordMismatch=!1,e.passReset=!0,r(function(){n.url("/home")},3e3)}):e.password2&&e.password1&&(e.passwordMismatch=!0)}}]),angular.module("eventApp").controller("twitterCtrl",["$scope","UserService","$stateParams","$location","$timeout",function(e,t,o,n,r){e.sendWelcomeMail=function(e){var o={mail:e.email,name:""};t.sendWelcomeMail(o).success(function(e,t,o,n){})};var a=n.search().twitToken;n.search("twitToken",null),a&&localStorage.setItem("twitToken",a),e.completeUserCheck=function(){localStorage.getItem("twitToken")&&t.decodeTwitUser().then(function(t){e.userId=t.data._id})},e.changeMail=function(o){localStorage.getItem("twitToken")&&t.editTwitUser(e.userId,o).then(function(t){t.data.code?e.emailTaken=!0:(e.sendWelcomeMail({email:o.email}),localStorage.removeItem("twitToken"),n.url("/home?token="+t.data.token))})}}]),angular.module("eventApp").value("baseUrl","https://roots-event-manager.herokuapp.com/api/"),angular.module("eventApp").factory("EventService",["$http","$stateParams","$location","$rootScope","Upload","baseUrl",function(e,t,o,n,r,a){return{createEvent:function(e){var t=localStorage.getItem("userToken");return r.upload({method:"POST",url:"/api/event?token="+t,file:e.imageUrl,fields:e})},editEventDetails:function(e,t){var o=localStorage.getItem("userToken");return r.upload({method:"PUT",url:"/api/event/"+t+"?token="+o,file:e.newImageUrl,fields:e})},deleteEvent:function(t){var o=localStorage.getItem("userToken");return e["delete"]("/api/event/"+t+"?token="+o)},editEventTasks:function(t,o){var n=localStorage.getItem("userToken");return e.put("/api/event/:event_id/tasks"+n,t,o)},getAllEvents:function(){return e.get("/api/events")},getEvent:function(t){return e.get("/api/event/"+t)},getMyPublishedEvents:function(){var t=localStorage.getItem("userToken");return e.get("/api/events/published?token="+t)},getMyEventDrafts:function(){var t=localStorage.getItem("userToken");return e.get("/api/events/saved?token="+t)},publishEvent:function(t){var o=localStorage.getItem("userToken");return e.put("/api/event/"+t+"/launch?token="+o)}}}]),angular.module("eventApp").factory("OrganizerService",["$http","Upload","baseUrl",function(e,t,o){return{createProfile:function(e){var o=localStorage.getItem("userToken");return t.upload({method:"POST",url:"/api/organizer?token="+o,file:e.newImage,fields:e})},editProfile:function(e){var o=localStorage.getItem("userToken");return t.upload({method:"PUT",url:"/api/organizer/"+e._id+"?token="+o,file:e.newImage,fields:e})},deleteProfile:function(){var t=localStorage.getItem("userToken");return e["delete"]("/api/organizer?token="+t)},getOrganizer:function(t){return e.get("/api/organizer/"+t)},getMyProfile:function(t){var o=localStorage.getItem("userToken");return e.get("/api/organizer/?token="+o)}}}]),angular.module("eventApp").factory("UserService",["$http","$stateParams","$location","$rootScope","Upload","baseUrl",function(e,t,o,n,r,a){function i(e){var t=e.replace("-","+").replace("_","/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}return window.atob(t)}return{createUser:function(t){return e.post("/api/users",t)},getCurrentUser:function(){var t=localStorage.getItem("userToken");return e.get("/api/user?token="+t)},editProfile:function(t){var o=localStorage.getItem("userToken");return e.put("/api/user?token="+o,t)},uploadPicture:function(e){var t=localStorage.getItem("userToken");return r.upload({method:"POST",url:"/api/user/uploadpic?token="+t,file:e.newImage,fields:e})},authenticate:function(t){return e.post("/api/authenticate",t)},decodeUser:function(){if(localStorage.getItem("userToken")){var e=localStorage.getItem("userToken"),t={};if(e){var o=e.split(".")[1];t=JSON.parse(i(o)),n.userName=t.firstname,n.profilePic=t.profilePic||"../../assets/img/icons/default-avatar.png",n.userId=t._id,n.loggedIn=!0}}},decodeTwitUser:function(){var t=localStorage.getItem("twitToken");return e.get("/api/decode?token="+t)},editTwitUser:function(t,o){return e.put("/api/twitterUser/"+t,o)},sendWelcomeMail:function(t){return e.post("/api/user/welcomeMail",t)},sendLink:function(t){return e.post("/api/forgotPass",t)},resetPassword:function(t,o){return e.post("/api/reset/"+t,o)}}}]);